<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"
    xmlns:vm="clr-namespace:GarageVelo.ViewModels"
    xmlns:models="clr-namespace:GarageVelo.Models"
    x:Class="GarageVelo.Views.HomePage"
    x:DataType="vm:HomeViewModel"
    Title="Carte"
    BackgroundColor="{StaticResource Surface}">

    <Grid RowDefinitions="2*,Auto,*">

        <!-- Map (hidden on Windows) -->
        <maps:Map
            x:Name="GarageMap"
            Grid.Row="0"
            MapType="Street">
            <maps:Map.IsVisible>
                <OnPlatform x:TypeArguments="x:Boolean">
                    <On Platform="WinUI" Value="False" />
                    <On Platform="Android,iOS,MacCatalyst" Value="True" />
                </OnPlatform>
            </maps:Map.IsVisible>
        </maps:Map>

        <!-- Windows fallback: full garage list instead of map -->
        <CollectionView
            x:Name="WindowsGarageList"
            Grid.Row="0" Grid.RowSpan="3"
            ItemsSource="{Binding Garages}"
            Margin="16,8,16,16">
            <CollectionView.IsVisible>
                <OnPlatform x:TypeArguments="x:Boolean">
                    <On Platform="WinUI" Value="True" />
                    <On Platform="Android,iOS,MacCatalyst" Value="False" />
                </OnPlatform>
            </CollectionView.IsVisible>
            <CollectionView.Header>
                <Frame
                    Style="{StaticResource CardFrame}"
                    Margin="0,8,0,8"
                    Padding="12">
                    <HorizontalStackLayout Spacing="8">
                        <Label
                            Text="GarageVelo"
                            Style="{StaticResource TitleLabel}"
                            FontSize="20"
                            VerticalOptions="Center"
                            TextColor="{StaticResource Primary}" />
                        <Label
                            Text="- Garages Lyon"
                            Style="{StaticResource SubtitleLabel}"
                            VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Frame>
            </CollectionView.Header>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Garage">
                    <Frame Style="{StaticResource CardFrame}" Margin="0,6" Padding="16">
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:HomeViewModel}}, Path=SelectGarageCommand}"
                                CommandParameter="{Binding .}" />
                        </Frame.GestureRecognizers>
                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="12">
                            <Label
                                Grid.Row="0" Grid.Column="0"
                                Text="{Binding Name}"
                                FontAttributes="Bold"
                                FontSize="16"
                                TextColor="{StaticResource Primary}" />
                            <Label
                                Grid.Row="0" Grid.Column="1"
                                Text="{Binding Size}"
                                FontSize="12"
                                TextColor="{StaticResource Accent}"
                                VerticalOptions="Center" />
                            <Label
                                Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                Text="{Binding Address}"
                                FontSize="13"
                                TextColor="{StaticResource TextSecondary}" />
                            <HorizontalStackLayout
                                Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2"
                                Spacing="16" Margin="0,6,0,0">
                                <Label FontSize="12" TextColor="{StaticResource Success}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding AvailableSlots}" FontAttributes="Bold" />
                                            <Span Text=" places disponibles" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label FontSize="12" TextColor="{StaticResource TextSecondary}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="/ " />
                                            <Span Text="{Binding TotalSlots}" />
                                            <Span Text=" total" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </HorizontalStackLayout>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Selected site banner (non-Windows) -->
        <Frame
            x:Name="SiteBanner"
            Grid.Row="1"
            Style="{StaticResource CardFrame}"
            Margin="16,8"
            Padding="12">
            <Frame.IsVisible>
                <OnPlatform x:TypeArguments="x:Boolean">
                    <On Platform="WinUI" Value="False" />
                    <On Platform="Android,iOS,MacCatalyst" Value="True" />
                </OnPlatform>
            </Frame.IsVisible>
            <Grid ColumnDefinitions="*,Auto">
                <VerticalStackLayout Grid.Column="0" Spacing="2">
                    <Label
                        Text="{Binding SelectedSite.Name}"
                        FontAttributes="Bold"
                        FontSize="16"
                        TextColor="{StaticResource Primary}" />
                    <Label
                        Text="{Binding SelectedSite.Address}"
                        FontSize="13"
                        TextColor="{StaticResource TextSecondary}" />
                </VerticalStackLayout>
                <Label
                    Grid.Column="1"
                    VerticalOptions="Center"
                    FontSize="13"
                    TextColor="{StaticResource Accent}">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="{Binding SiteGarages.Count}" FontAttributes="Bold" />
                            <Span Text=" garage(s)" />
                        </FormattedString>
                    </Label.FormattedText>
                </Label>
            </Grid>
        </Frame>

        <!-- Garages of selected site (non-Windows) -->
        <CollectionView
            x:Name="SiteGarageList"
            Grid.Row="2"
            ItemsSource="{Binding SiteGarages}"
            Margin="16,0,16,8">
            <CollectionView.IsVisible>
                <OnPlatform x:TypeArguments="x:Boolean">
                    <On Platform="WinUI" Value="False" />
                    <On Platform="Android,iOS,MacCatalyst" Value="True" />
                </OnPlatform>
            </CollectionView.IsVisible>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Garage">
                    <Frame Style="{StaticResource CardFrame}" Margin="0,4" Padding="12">
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer
                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:HomeViewModel}}, Path=SelectGarageCommand}"
                                CommandParameter="{Binding .}" />
                        </Frame.GestureRecognizers>
                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12">
                            <Label
                                Grid.Row="0" Grid.Column="0"
                                Text="{Binding Name}"
                                FontAttributes="Bold"
                                FontSize="15"
                                TextColor="{StaticResource Primary}" />
                            <Label
                                Grid.Row="0" Grid.Column="1"
                                Text="{Binding Size}"
                                FontSize="12"
                                TextColor="{StaticResource Accent}"
                                VerticalOptions="Center" />
                            <HorizontalStackLayout
                                Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                Spacing="16" Margin="0,4,0,0">
                                <Label FontSize="12" TextColor="{StaticResource Success}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="{Binding AvailableSlots}" FontAttributes="Bold" />
                                            <Span Text=" dispo" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label FontSize="12" TextColor="{StaticResource TextSecondary}">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span Text="/ " />
                                            <Span Text="{Binding TotalSlots}" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                            </HorizontalStackLayout>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Loading indicator -->
        <ActivityIndicator
            Grid.Row="0" Grid.RowSpan="3"
            IsRunning="{Binding IsBusy}"
            IsVisible="{Binding IsBusy}"
            VerticalOptions="Center"
            HorizontalOptions="Center" />

    </Grid>
</ContentPage>
